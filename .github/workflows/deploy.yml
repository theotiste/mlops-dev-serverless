name: deploy-dev

on:
  push:
    branches: [ "main" ]
    paths:
      - "serverless.yml"
      - "serverless.yaml"
      - "handler.py"
      - "features_input.json"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      stage:
        description: "Stage"
        required: false
        default: "dev"
      region:
        description: "AWS region"
        required: false
        default: "eu-west-3"

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  STAGE: ${{ github.event.inputs.stage || 'dev' }}
  AWS_REGION: ${{ github.event.inputs.region || 'eu-west-3' }}
  SERVICE_NAME: cancer-prediction-api
  SLS_TELEMETRY_DISABLED: "1"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (no cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Serverless CLI
        run: npm i -g serverless@^4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null
          jq --version

      - name: Show versions
        run: |
          node -v
          npm -v
          serverless -v

      # ⛅️ AWS credentials (utilise tes clés longues durée en secrets)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate Serverless config
        env:
          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
        run: |
          set -euo pipefail
          serverless print --stage "$STAGE" --region "$AWS_REGION" >/dev/null
          echo "serverless.* OK"

      - name: Deploy
        env:
          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
        run: |
          set -euo pipefail
          serverless deploy --stage "$STAGE" --region "$AWS_REGION" --conceal

      - name: Fetch API base URL (sls info)
        env:
          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
        run: |
          set -euo pipefail
          serverless info --stage "$STAGE" --region "$AWS_REGION" > sls-info.txt || true
          echo "=== sls-info.txt ==="
          cat sls-info.txt || true

      # 🔎 Résolution robuste des endpoints
      - name: Resolve endpoints (health & predict)
        id: resolve
        shell: bash
        env:
          HEALTH_URL_SECRET: ${{ secrets.HEALTH_URL }}   # ex: https://api.mlopstheotiste.fr/health (optionnel mais recommandé)
        run: |
          set -euo pipefail

          echo "::group::sls-info.txt"
          cat sls-info.txt || true
          echo "::endgroup::"

          BASE_URL=""
          HEALTH_URL=""

          # 1) Secret direct (si fourni)
          if [ -n "${HEALTH_URL_SECRET:-}" ]; then
            HEALTH_URL="$HEALTH_URL_SECRET"
            BASE_URL="${HEALTH_URL%/health}"
          fi

          # 2) sls-info: URL /health explicite
          if [ -z "${HEALTH_URL}" ]; then
            url=$(grep -Eo 'https://[^ ]+/health' sls-info.txt | head -1 || true)
            if [ -n "${url}" ]; then
              HEALTH_URL="$url"
              BASE_URL="${HEALTH_URL%/health}"
            fi
          fi

          # 3) sls-info: 1ère URL générique
          if [ -z "${BASE_URL}" ]; then
            base=$(grep -Eo 'https://[^ ]+' sls-info.txt | head -1 || true)
            if [ -n "${base}" ]; then
              BASE_URL="${base%/}"
            fi
          fi

          # 4) CloudFormation Outputs (ServiceEndpoint / HttpApiUrl)
          if [ -z "${BASE_URL}" ]; then
            STACK="${SERVICE_NAME}-${STAGE}"
            outs=$(aws cloudformation describe-stacks \
              --stack-name "$STACK" --region "$AWS_REGION" \
              --query "Stacks[0].Outputs[].OutputValue" --output text 2>/dev/null || true)
            if [ -n "${outs}" ]; then
              BASE_URL=$(printf "%s\n" $outs | grep -E 'https://.*execute-api\..*amazonaws.com' | head -1 || true)
              BASE_URL="${BASE_URL%/}"
            fi
          fi

          # 5) Compose HEALTH_URL si besoin
          if [ -z "${HEALTH_URL}" ] && [ -n "${BASE_URL}" ]; then
            case "$BASE_URL" in
              */health) HEALTH_URL="$BASE_URL" ;;
              *)        HEALTH_URL="${BASE_URL}/health" ;;
            esac
          fi

          if [ -z "${HEALTH_URL}" ] || [ -z "${BASE_URL}" ]; then
            echo "❌ Aucune URL d'API trouvée. Définis le secret HEALTH_URL (ex: https://ton-api/health) ou expose ServiceEndpoint dans les Outputs CFN."
            exit 1
          fi

          echo "BASE_URL_RESOLVED=$BASE_URL"     | tee -a "$GITHUB_ENV"
          echo "HEALTH_URL_RESOLVED=$HEALTH_URL" | tee -a "$GITHUB_ENV"
          echo "Resolved BASE_URL=$BASE_URL"
          echo "Resolved HEALTH_URL=$HEALTH_URL"

      - name: Smoke test /health (resolved)
        shell: bash
        run: |
          set -euo pipefail
          HEALTH_URL="${HEALTH_URL_RESOLVED:?missing}"
          echo "Health URL: $HEALTH_URL"

          ok=false
          for i in {1..6}; do
            code=$(curl -sS -m 12 -o /tmp/body.txt -w "%{http_code}" "$HEALTH_URL" || true)
            echo "::group::Attempt $i - HTTP ${code}"
            sed -e 's/^/| /' /tmp/body.txt || true
            echo "::endgroup::"
            if [ "$code" = "200" ] || [ "$code" = "204" ]; then ok=true; break; fi
            sleep $((i*5))
          done

          if [ "$ok" != "true" ]; then
            echo "❌ Healthcheck failed on $HEALTH_URL"
            echo "::group::Derniers logs CloudWatch (health)"
            serverless logs -f health -s "$STAGE" -r "$AWS_REGION" --startTime 10m || true
            echo "::endgroup::"
            exit 1
          fi

      - name: Smoke test /predict (optional)
        if: ${{ hashFiles('features_input.json') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          BASE="${BASE_URL_RESOLVED:?missing}"
          PRED="${BASE%/}/predict"
          echo "Predict URL: ${PRED}"
          RES=$(curl -fsS -H "Content-Type: application/json" -d @features_input.json "$PRED")
          echo "$RES" | tee predict-response.json
          jq -e '.predictions or .probabilities or .prediction or .result' predict-response.json >/dev/null

      - name: Upload sls info
        uses: actions/upload-artifact@v4
        with:
          name: sls-info
          path: |
            sls-info.txt
            predict-response.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Job summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Deploy summary"
            echo "- **Service**: ${SERVICE_NAME}"
            echo "- **Stage**: ${STAGE}"
            echo "- **Region**: ${AWS_REGION}"
            echo "- **BASE URL**: ${BASE_URL_RESOLVED}"
            echo "- **Health**: ${HEALTH_URL_RESOLVED}"
            [ -f predict-response.json ] && echo "- **Predict sample**: $(jq -c '.' predict-response.json)" || true
          } >> "$GITHUB_STEP_SUMMARY"
